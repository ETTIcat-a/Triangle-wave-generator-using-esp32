#include "BluetoothSerial.h"
#include <driver/dac.h>
BluetoothSerial ESP_BT;

const unisgned short ADC_pin = 15;  
float analog_voltage=0,freq, ampl,numar;
unisgned short incoming;
unisgned short k = 0, j;

void setup() {
   Serial.begin(9600);
  ESP_BT.begin("Codrinel si Marinel");
  dac_output_enable(DAC_CHANNEL_1);
  k = 0;
}

void loop() {
 
if(k == 0){	//pana ma conectez la telefon k se face 1 si primul BT.print nu se afiseaza
  delay(1);
ESP_BT.print("Introduceti amplitudinea semnalului: ");
k = 1;
}
if(k == 2){
ESP_BT.print("Introduceti frecventa semnalului: ");
k = 3;
}
 if (ESP_BT.available()){
 incoming = ESP_BT.read();
 numar = 0; // resetam numarul 
 while(incoming != 10){ // cand introducem un numar pe seriala BT, in incoming vin si caracterele ENTER(13) si FEED_LINE(10), pe care trb sa le ignoram, asa ca, numarul nostru se termina cand
 //s-a receptionat caracterul new_line
   if(incoming != 13) // daca se receptioneaza caracterul ENTER(13), se sare peste el
numar = numar * 10 + incoming - 48; // incoming receptioneaza cifra cu cifra, ca sa formam numarul trenuie sa inmultim cu 10 cifra precedenta. In plus, incoming e in ASCII, trb scazut 48
incoming = ESP_BT.read();
 }
 if(numar == 0){
   ampl = 0;
   freq = 0;
   k = 0;
 }
 else if(ampl == 0){
ampl = unisgned short((numar  / 3.3) * 255);
k = 2;
 }
else
freq = 1000 / numar / ampl / 2;
 }
 /*
//---------------------------------------------------------------	TODO: Trb testat pe osciloscop(DONE)

+ functia de delay in microseconds
*/
 ESP_BT.println("Not in loop");
 ESP_BT.println(ampl);
  ESP_BT.println(freq );
  delay(2000);
   
if(freq != 0 ){
 
  analog_voltage = 0;
  for (unisgned short i = 0; i < ampl; i ++){
  dac_output_voltage(DAC_CHANNEL_2, i);
  delay(freq);
  analog_voltage = analog_voltage + analogRead(ADC_pin);
 j ++;
  }
  for (unisgned short i = ampl; i > 0; i --){
  dac_output_voltage(DAC_CHANNEL_2, i);
  delay(freq);
  analog_voltage = analog_voltage + analogRead(ADC_pin);
  j ++;
  }
  
  
  if (j == 3000){
    analog_voltage = analog_voltage/400;
    ESP_BT.print("Valoarea media a semnalului generat de DAC este:");
  ESP_BT.print(analog_voltage*3.3/4096);
  j = 0;
  }
}
}